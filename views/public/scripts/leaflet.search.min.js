$(document).ready(function () {
  var filterForm = formBuilder("searchForm", ['agency', 'gps_date_search', 'primary_ob', 't_e_specie_search'], null).show()
  $("#filterForm").html(filterForm)
  var filterType = null, filterShape = null, filterArray = [], filteredLayers = [];
  function collectFilterData(form) {
    const obj = {};
    $(form).serializeArray().reduce(function(i, item) {
       if (item.value === '' || item.value === 'select' || (item.name === 'agency' && item.value == -1)) {
          // do nothing
       } else if (item.name === 'agency') {
          obj[item.name] = parseInt(item.value);
       } else {
          obj[item.name] = item.value;
       }
    }, {});
    return obj;
    
  }
  $("#filterSearch").click(function(){
    $(this).hide();
    $("#searchStep").hide();
    $("#searchFilters").show();
    $("#filterClear").show();
  });
  
  $(".filterType a[data-toggle=tab]").click(function(e) {
    if(filterType == e.target.attributes[1].value){
      setTimeout(function(){
        $(".filterType li").removeClass("active")
        $("#markerFilter")[0].parentElement.className = ""
        $("#polygonFilter")[0].parentElement.className = ""
      }, 100);
      filterType = null;
    }
    else {
      $(".filterShape li").removeClass("active");
      filterType = $(this).attr("value");
      filterShape = null;
      if (filterType == "B") {
        $("#markerFilter")[0].parentElement.className = "disabled"
        $("#polygonFilter")[0].parentElement.className = "disabled"
      }
      else {
        $("#markerFilter")[0].parentElement.className = ""
        $("#polygonFilter")[0].parentElement.className = ""
      }
    }
    //changeFilterForm()
  });
  $(".filterShape a[data-toggle=tab]").click(function(e) {
    if ($(e.target.parentElement).hasClass("disabled")) {
      e.preventDefault();
      return false;
    }
    else if(filterShape == e.target.attributes[2].value){
      setTimeout(function(){
        $(".filterShape li").removeClass("active")
      }, 100);
      filterShape = null;
    }
    else{
      filterShape = $(this).attr("value");
      //changeFilterForm()
    }
  });
  $("#filterSearchButton").click(function(){
    filterArray = collectFilterData("#searchForm");
    var filteredLayers = [];
    if (filterType ==  "R"){
      switch (filterShape) {
        case 'M': {
          filteredLayers = searchByFilter("RPoints");
          break;
        }
        case 'L': {
          filteredLayers = searchByFilter("RLines");
          break;
        }
        case 'P': {
          filteredLayers = searchByFilter("RPolys");
          break;
        }
        default: {
          filteredLayers = searchByFilter("RPoints").concat(searchByFilter("RLines")).concat(searchByFilter("RPolys"));
          break;
        }
      }
    } else if (filterType ==  "D"){
      switch (filterShape) {
        case 'M': {
          filteredLayers = searchByFilter("DPoints");
          break;
        }
        case 'L': {
          filteredLayers = searchByFilter("DLines");
          break;
        }
        case 'P': {
          filteredLayers = searchByFilter("DPolys");
          break;
        }
        default: {
          filteredLayers = searchByFilter("DPoints").concat(searchByFilter("DLines")).concat(searchByFilter("DPolys"));
          break;
        }
      }
    } else if (filterType == "B"){
      filteredLayers = searchByFilter("Barriers");
    } else {
      filteredLayers = searchByFilter("RPoints").concat(searchByFilter("RLines")).concat(searchByFilter("RPolys")).concat(searchByFilter("DPoints")).concat(searchByFilter("DLines")).concat(searchByFilter("DPolys")).concat(searchByFilter("Barriers"));
    }
    createFilteredList(filteredLayers);
  })
  function getAgencyName(agency)
  {
    switch (agency) {
      case 0:
        return "BLM";
        break;
      case 1:
        return "NPS";
        break;
      case 2:
        return "FS";
        break;
      case 3:
        return "FWS";
        break;
      default:
        return "NULL"
        break;
    }
  }
  function clearLayers(exception) {
    for (var type in savedLayers){
      if (type != exception)
        map.removeLayer(savedLayers[type]);
      else
        map.addLayer(savedLayers[type]);
    }
  }
  function clearFilters(){
    for (var type in savedLayers){
      console.log(savedLayers[type])
      map.addLayer(savedLayers[type]);
    }
  }
  $("#filterBack").click(function() {
    $("#searchFilters").hide()
    $('#filterClear').hide();
    $("#filterSearch").show();
    $("#searchStep").show();
  })
  $('#filterClear').click(function(){
    clearFilters();
    $(this).hide();
    $("#filterSearch").show();
  });
  function createFilteredList(featureList){
    $("#filteredFeatures").html("");
    console.log(featureList)
    if (featureList.length == 0)
      $("#filteredFeatures").html("<tr><td colspan=42>No records were found for selected filters</td></tr>");
    for (var index in featureList){
      var row = $("<tr>").append($("<td>", {text: featureList[index].feature.properties.gid}))
                         .append($("<td>", {text: featureList[index].feature.properties.gid}))
                         .append($("<td>", {text: featureList[index].feature.properties.gid}))
                         .append($("<td>", {text: getAgencyName(featureList[index].feature.properties.agency)}))
                         .append($("<td>", {text: featureList[index].feature.properties.region}))
                         .append($("<td>", {text: featureList[index].feature.properties.gid}))
                         .append($("<td>", {text: featureList[index].feature.properties.gps_date}))
                         .append($("<td>", {text: featureList[index].feature.properties.primary_ob}))
                         .append($("<td>", {text: featureList[index].feature.properties.gid}))
                         .append($("<td>").append($("<button>", {class: "btn btn-default", text: "View", value: index}).click(function(e){console.log(e.target.value, featureList[e.target.value]);featureList[e.target.value].fireEvent('click')})))
      $("#filteredFeatures").append(row);
    }
  }
  function searchByFilter(type) {
    $("#searchFilters").hide()
    $("#searchStep").show();
    filteredLayers = [];
    for (var index in filterArray)
    {
      if (filterArray[index] != null) {
        for(var feature in savedLayers[type]._layers)
        {
          if (filterArray[index] != savedLayers[type]._layers[feature].feature.properties[index]){
            map.removeLayer(savedLayers[type]._layers[feature]);
          }
          else if (filteredLayers.indexOf(savedLayers[type]._layers[feature]) == -1)
            filteredLayers.push(savedLayers[type]._layers[feature]);
        }
      }
    }
    return filteredLayers;
  }
  console.log("map", map)
  $("#searchButton").click(function(){
    //console.log($("#searchID").val())
    var val = $("#searchID").val().toLowerCase();
    filteredLayers = [];
    for(var index in map._targets){
        if (map._targets[index].feature != null) {
            var match = false;
            for (var prop in map._targets[index].feature.properties)
            {
                if (typeof map._targets[index].feature.properties[prop] === 'string')
                    if (map._targets[index].feature.properties[prop].toLowerCase().includes(val)){
                        match = true;
                        break;
                    }
            }
            if (match == true)
                filteredLayers.push(map._targets[index]);
      }
    }
    createFilteredList(filteredLayers);
  })
});